@model GeneratePageModel

<ul class="nav nav-pills mb-3" role="tablist" id="servertablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" data-bs-toggle="tab" href="#Server-Info" id="serverinfotabbutton" aria-selected="true" role="tab">Server Info</a>
    </li>
    <li class="nav-item" role="presentation" data-requiredpermission="view_backends_list">
        <a class="nav-link" data-bs-toggle="tab" href="#Settings-Backends" id="serverbackendstabbutton" aria-selected="false" role="tab">Backends</a>
    </li>
    <li class="nav-item" role="presentation" data-requiredpermission="read_server_settings">
        <a class="nav-link" data-bs-toggle="tab" href="#Settings-Server" id="serverconfigtabbutton" aria-selected="false" tabindex="-1" role="tab">Server Configuration</a>
    </li>
    <li class="nav-item" role="presentation" data-requiredpermission="manage_users">
        <a class="nav-link" data-bs-toggle="tab" href="#Server-ManageUsers" id="manageusersbutton" aria-selected="false" tabindex="-1" role="tab">Users</a>
    </li>
    <li class="nav-item" role="presentation" data-requiredpermission="manage_extensions">
        <a class="nav-link" data-bs-toggle="tab" href="#Server-Extensions" id="extensionstabbutton" aria-selected="false" tabindex="-1" role="tab">Extensions</a>
    </li>
    <li class="nav-item" role="presentation" data-requiredpermission="view_logs">
        <a class="nav-link" data-bs-toggle="tab" href="#Server-Logs" id="logtabbutton" aria-selected="false" tabindex="-1" role="tab">Logs</a>
    </li>
</ul>
<div class="tab-content">
    <div class="tab-pane show active" id="Server-Info" role="tabpanel">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card border-secondary mb-3">
                        <div class="card-header">Server</div>
                        <div class="card-body">
                            <p class="card-text">
                                The "Server" tab provides access to SwarmUI's server internals, including:
                                <span data-requiredpermission="view_backends_list"><br>&bullet; The <a href="#Settings-Backends" onclick="getRequiredElementById('serverbackendstabbutton').click()">Backends</a> tab, which allows you to configure and manage backends.</span>
                                <span data-requiredpermission="read_server_settings"><br>&bullet; The <a href="#Settings-Server" onclick="getRequiredElementById('serverconfigtabbutton').click()">Server Configuration</a> tab, which allows you to configure and manage Swarm's settings.</span>
                                <span data-requiredpermission="manage_extensions"><br>&bullet; The <a href="#Server-Extensions" onclick="getRequiredElementById('extensionstabbutton').click()">Extensions</a> tab, which provides ways to manage your Swarm extensions.</span>
                                <span data-requiredpermission="view_logs"><br>&bullet; The <a href="#Server-Logs" onclick="getRequiredElementById('logtabbutton').click()">Logs</a> tab, which allows you to view the server logs.</span>
                                <br><br>
                                This is not to be confused with the <a href="#user_tab" onclick="getRequiredElementById('usersettingstabbutton').click();getRequiredElementById('userconfigtabbutton').click()">User Settings</a> tab.
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-secondary mb-3" data-requiredpermission="read_server_info_panels">
                                <div class="card-header">Local Network</div>
                                <div class="card-body">
                                    @if (Program.ServerSettings.Network.Host == "127.0.0.1" || Program.ServerSettings.Network.Host == "localhost")
                                    {
                                        <p>This server is only accessible from this computer.</p>
                                    }
                                    else
                                    {
                                        string address = Utilities.GetLocalIPAddress();
                                        if (address is null)
                                        {
                                            <p><span>Unknown local address, but seems to be open to LAN based on Host setting</span><br><code>@(Program.ServerSettings.Network.Host)</code></p>
                                        }
                                        else
                                        {
                                            <p><span>This server is likely accessible from LAN on one of the following addresses:</span><br><code>@address</code></p>
                                        }
                                    }
                                    @if (Program.ProxyHandler is not null && Program.ProxyHandler.PublicURL is not null)
                                    {
                                        <p><span>This server is also accessible from the open internet at:</span><br><code>@(Program.ProxyHandler?.PublicURL)</code></p>
                                    }
                                </div>
                            </div>
                            <div class="card border-secondary mb-3" data-requiredpermission="read_server_info_panels">
                                <div class="card-header">Resource Usage</div>
                                <div class="card-body" id="resource_usage_area">(Loading...)</div>
                            </div>
                            <div class="card border-secondary mb-3" data-requiredpermission="read_server_info_panels">
                                <div class="card-header">Connected Users</div>
                                <div class="card-body" id="connected_users_list">(Loading...)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="card border-secondary mb-3" id="server_updates_card" data-requiredpermission="restart">
                                <div class="card-header">Update</div>
                                <div class="card-body">
                                    @if (Program.VersionUpdateMessageShort is not null)
                                    {
                                        <div>@(new HtmlString(Program.VersionUpdateMessageShort))</div>
                                    }
                                    <div id="updates_available_notice_area" style="white-space:pre-wrap">(Loading...)</div>
                                    <button class="btn btn-sm btn-secondary mt-2" onclick="check_for_updates()">Check For Updates</button>
                                    <hr>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="server_update_include_extensions" checked>
                                        <label class="form-check-label" for="server_update_include_extensions">Include Extensions</label>
                                    </div>
                                    <button class="btn btn-danger mt-2" onclick="update_and_restart_server()">Update and Restart Server</button>
                                    <div id="update_server_notice_area" class="mt-2"></div>
                                </div>
                            </div>
                            <div class="card border-danger mb-3" data-requiredpermission="shutdown">
                                <div class="card-header">Shutdown</div>
                                <div class="card-body">
                                    <p>If you want to shut down the server, click the button below.</p>
                                    <button class="btn btn-danger" onclick="shutdown_server()">Shutdown Server</button>
                                    <div id="shutdown_notice_area" class="mt-2"></div>
                                </div>
                            </div>
                            <div class="card border-secondary mb-3" data-requiredpermission="control_mem_clean">
                                <div class="card-header">Free Memory</div>
                                <div class="card-body">
                                    <p>You can free up the VRAM usage, or system memory usage (cache) from backends with the two buttons below.</p>
                                    <div class="btn-group">
                                        <button class="btn btn-warning" onclick="server_clear_vram()">Free VRAM</button>
                                        <button class="btn btn-warning" onclick="server_clear_sysram()">Free System RAM</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @if (Utilities.DotNetVersMissing is not null)
                    {
                        <div class="alert alert-danger">DotNET @Utilities.DotNetVersMissing Missing: You do not seem to have DotNET @Utilities.DotNetVersMissing installed - this will be required in a future version of SwarmUI. Please install DotNET SDK @(Utilities.DotNetVersMissing).0 from <a target="_blank" href="https://dotnet.microsoft.com/en-us/download/dotnet/@(Utilities.DotNetVersMissing).0" class="alert-link">here</a>.</div>
                    }
                    @if (Program.CurrentGitDate == "Git failed to load")
                    {
                        <div class="alert alert-danger">Git Failed To Load: You seem to have installed SwarmUI improperly. Many features, including auto-updating, will not work. Please install SwarmUI as explained in <a target="_blank" href="https://github.com/mcmonkeyprojects/SwarmUI?tab=readme-ov-file#installing-on-windows" class="alert-link">The readme install instructions.</a></div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane" id="Settings-Backends" role="tabpanel">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center my-3">
                <div>
                    Add new backend of type:
                    <div class="form-check form-switch d-inline-block ms-2">
                        <input class="form-check-input" type="checkbox" id="backends_show_advanced" title="Show Advanced Backend Types" onclick="toggleShowAdvancedBackends()" autocomplete="off">
                        <label class="form-check-label" for="backends_show_advanced">Show Advanced</label>
                    </div>
                    <div id="backend_add_buttons" class="d-inline-block"></div>
                </div>
                <button class="btn btn-primary" onclick="restart_all_backends()">Restart All Backends</button>
            </div>
            <div class="backends_list" id="backends_list"></div>
        </div>
    </div>
    <div class="tab-pane" id="Settings-Server" role="tabpanel">
        <div id="server_settings_container" class="container mt-3"></div>
        <div class="settings_submit_confirmer" id="serversettings_confirmer">
            <span class="settings_submit_confirmer_text">Save <span id="serversettings_edit_count">0</span> edited setting(s)?</span>
            <button type="button" class="btn btn-primary" onclick="save_server_settings()">Save</button>
            <button type="button" class="btn btn-secondary" onclick="cancel_server_settings_edit()">Cancel</button>
        </div>
    </div>
    <div class="tab-pane" id="Server-Logs" role="tabpanel">
        @WebUtil.ModalHeader("do_log_pastebin_modal", "Submit Logs To Pastebin")
            <div class="modal-body">
                <p>This will submit the text of your server logs to a <a target="_blank" href="https://paste.denizenscript.com/New/Swarm">public pastebin service</a>. This is to make it easy to share debug logs when getting support on the <a target="_blank" href="https://discord.gg/q2y38cqjNw">SwarmUI discord</a>.</p>
                <p>Once submitted, your server logs will be visible to the public and not easily deletable. Please ensure your logs do not contain private information (eg personal prompts) before autosubmitting.</p>
                <p>(If your logs do have private information, please restart and replicate whatever you need to show, then pastebin the logs).</p>
                <p>(Alternately, you can manually submit and edit the content first via <a target="_blank" href="https://paste.denizenscript.com/New/Swarm">this link</a>, just be sure not to delete anything important).</p>
                <div class="mb-3">
                    <label for="log_pastebin_type" class="form-label">Which minimum log level would you like to submit?</label>
                    <select id="log_pastebin_type" class="form-select" autocomplete="off"><option>verbose</option><option selected>debug</option><option>info</option></select>
                </div>
                <div id="log_pastebin_result_area"></div>
            </div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" id="log_submit_pastebin_button">Submit</button><button type="button" class="btn btn-secondary" id="log_cancel_pastebin_button" data-bs-dismiss="modal">Cancel</button></div>
        @WebUtil.ModalFooter()
        <div class="text-center my-3">
            <div class="d-inline-block">
                <label for="server_log_type_selector" class="form-label">View:</label>
                <select id="server_log_type_selector" class="form-select d-inline-block w-auto"></select>
            </div>
            <div class="d-inline-block">
                <label for="server_log_filter" class="form-label">Filter:</label>
                <input type="text" id="server_log_filter" class="form-control d-inline-block w-auto" placeholder="Filter" />
            </div>
            <button class="btn btn-secondary" id="server_log_pastebin">Pastebin</button>
        </div>
        <div id="server_logs_container" class="border rounded p-2" style="height: 75vh; overflow-y: auto;"></div>
    </div>
    <div class="tab-pane" id="Server-Extensions" role="tabpanel">
        <div class="container">
            <div class="alert alert-info mt-3">The "Extensions" tab lets you control your installed Swarm extensions, or install new ones.</div>
            <div class="alert alert-warning" id="extensions_installed_card" style="display:none">
                Extensions installed or updated. Changes will apply the next time you restart the SwarmUI server.
                <button class="btn btn-sm btn-primary ms-2" id="extension_restart_button" onclick="extensionsManager.restartServer()">Restart Now</button>
            </div>
            <h3 class="mt-4">Installed Extensions</h3>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead><tr><th>Name</th><th>Version</th><th>Tags</th><th>Author</th><th>Description</th><th>Readme</th><th>License</th><th>Actions</th></tr></thead>
                    <tbody>
                    @foreach (Extension ext in Program.Extensions.Extensions.Where(e => !e.IsCore))
                    {
                        <tr>
                            <td>@ext.ExtensionName</td>
                            <td><code>@ext.Version</code></td>
                            <td>@ExtensionsManager.HtmlTags(ext.Tags)</td>
                            <td>@ext.ExtensionAuthor</td>
                            <td>@ext.Description</td>
                            <td>@(ext.ReadmeURL == "" ? "(Missing)": new HtmlString($"<a target=\"_blank\" href=\"{ext.ReadmeURL}\">Here</a>"))</td>
                            <td class="@(ext.License == "MIT" ? "" : "text-danger")">@ext.License</td>
                            <td>
                                <div class="btn-group">
                                @if (ext.CanUpdate)
                                {
                                    <button class="btn btn-sm btn-success" onclick="extensionsManager.updateExtension('@ext.ExtensionName', this)">Update</button>
                                }
                                <button class="btn btn-sm btn-danger" onclick="extensionsManager.uninstallExtension('@ext.ExtensionName', this)">Uninstall</button>
                                </div>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <h3 class="mt-4">Available Extensions</h3>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead><tr><th>Name</th><th>Tags</th><th>Author</th><th>Description</th><th>Readme</th><th>License</th><th>Actions</th></tr></thead>
                    <tbody>
                    @foreach (ExtensionsManager.ExtensionInfo ext in Program.Extensions.KnownExtensions.Where(e => !Program.Extensions.LoadedExtensionFolders.Contains(e.FolderName) && !e.Tags.Contains("hidden")))
                    {
                        <tr>
                            <td>@ext.Name</td>
                            <td>@ExtensionsManager.HtmlTags(ext.Tags)</td>
                            <td>@ext.Author</td>
                            <td>@ext.Description</td>
                            <td><a target="_blank" href="@ext.URL">Here</a></td>
                            <td class="@(ext.License == "MIT" ? "" : "text-danger")">@ext.License</td>
                            <td><button class="btn btn-sm btn-primary" onclick="extensionsManager.installExtension('@ext.Name', this)">Install</button></td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="tab-pane" id="Server-ManageUsers" role="tabpanel">
        @WebUtil.ModalHeader("server_add_user_menu", "Add New User Account")
            <div class="modal-body">
                <p>This will add a new user account to your SwarmUI server.</p>
                <p>Please configure carefully, the account will be active immediately upon click 'Add' below.</p>
                <p>Click 'Cancel' if you're not ready to add a user.</p>
                <div id="add_user_menu_inputs"></div>
            </div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="userAdminManager.addUserMenuSubmit()">Add</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
        @WebUtil.ModalFooter()
        @WebUtil.ModalHeader("server_add_role_menu", "Add New User Permission Role")
            <div class="modal-body">
                <p>This will add a new user permission role to your SwarmUI server.</p>
                <p>This should be used when you need to define unique contexts in which certain users get a certain subset of permissions.</p>
                <p>For the most part, you should just configure the base set of roles rather than adding new ones..</p>
                <p>Click 'Cancel' if you're not ready to add a user.</p>
                <div id="add_role_menu_inputs"></div>
            </div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="userAdminManager.addRoleMenuSubmit()">Add</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
        @WebUtil.ModalFooter()
        @WebUtil.ModalHeader("server_change_user_password_modal", "Change User Password")
            <div class="modal-body">
                <p>This form lets you change another user's password. Be sure to tell them what their new password is, and that they should change their password themself after.</p>
                <div class="mb-3">
                    <label for="server_change_user_password_new_password" class="form-label">New Password:</label>
                    <input type="password" class="form-control" id="server_change_user_password_new_password" placeholder="Enter new password..." autocomplete="off">
                </div>
                <div class="mb-3">
                    <label for="server_change_user_password_new_password2" class="form-label">Confirm New Password:</label>
                    <input type="password" class="form-control" id="server_change_user_password_new_password2" placeholder="Confirm new password..." autocomplete="off">
                </div>
                <div id="server_change_user_password_result_area"></div>
            </div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" id="server_change_user_password_submit_button" onclick="userAdminManager.changeUserPwSubmit()">Submit</button><button type="button" class="btn btn-secondary" id="server_change_user_password_cancel_button" data-bs-dismiss="modal">Cancel</button></div>
        @WebUtil.ModalFooter()
        <div class="d-flex h-100">
            <div class="flex-shrink-0 p-3 border-end" style="width: 280px;">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="admin_user_filter" oninput="userAdminManager.updateFilter()" placeholder="Filter users/roles..." />
                    <button class="btn btn-outline-secondary" type="button" id="admin_user_clear_input_icon" onclick="userAdminManager.clearFilter()">&#x2715;</button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="h5">Roles</span>
                    <button class="btn btn-sm btn-primary" onclick="userAdminManager.showAddRoleMenu()" title="Add a new role...">Add Role</button>
                </div>
                <div id="manage_users_leftbox_content_rolelist" class="list-group mb-3"></div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="h5">Users</span>
                    <button class="btn btn-sm btn-primary" onclick="userAdminManager.showAddUserMenu()" title="Add a new user...">Add User</button>
                </div>
                <div id="manage_users_leftbox_content_userlist" class="list-group"></div>
            </div>
            <div class="flex-grow-1 p-3" id="manage_users_rightbox">
                <div id="manage_users_rightbox_content"></div>
            </div>
        </div>
    </div>
</div>
