@page
@{
    ViewData["Title"] = "Page is loading...";
    GeneratePageModel pageModel = new(HttpContext);
    string doCheckForUpdates = Program.ServerSettings.Maintenance.CheckForUpdates ? "true" : "false";
}
@section Header {
    <link rel="stylesheet" href="css/genpage.css?vary=@Utilities.VaryID" />
}

@if (!Program.ServerSettings.IsInstalled)
{
    <script>
        window.location.href = "Install";
    </script>
    return;
}
@if (pageModel.IsLoginEnabled && pageModel.User is null)
{
    <script>
        window.location.href = "Login";
    </script>
    return;
}
<script>
    window.alwaysRefreshOnLoad = @pageModel.AlwaysRefreshOnLoad;
    window.instanceTitle = "@pageModel.InstanceTitle";
    window.comfy_features = {};
    window.checkForUpdatesAutomatically = @doCheckForUpdates;
    @foreach (InstallableFeatures.ComfyInstallableFeature feature in InstallableFeatures.ComfyFeatures.Values)
    {
        <text>
            window.comfy_features["@feature.ID"] = {
                "display_name": "@feature.DisplayName",
                "id": "@feature.ID",
                "url": "@feature.URL",
                "author": "@feature.Author",
                "notice": "@(new HtmlString(Utilities.EscapeJsonString(feature.Notice)))"
            };
        </text>
    }
</script>

<div class="container-fluid mt-2">
    <!-- Navigation moved to main header in _Layout.cshtml -->
    <div class="tab-content tab-hundred">
        <div class="tab-pane tab-pane-vw" id="Simple" role="tabpanel">
            @await Html.PartialAsync("_Generate/SimpleTab.cshtml", pageModel)
        </div>
        <div class="tab-pane tab-pane-vw show active" id="Text2Image" role="tabpanel">
            @await Html.PartialAsync("_Generate/GenerateTab.cshtml", pageModel)
        </div>
        @WebServer.T2ITabBody
        <div class="tab-pane tab-pane-vw" id="utilities_tab" role="tabpanel">
            @await Html.PartialAsync("_Generate/UtilitiesTab.cshtml", pageModel)
        </div>
        <div class="tab-pane tab-pane-vw" id="user_tab" role="tabpanel">
            @await Html.PartialAsync("_Generate/UserTab.cshtml", pageModel)
        </div>
        <div class="tab-pane tab-pane-vw" id="server_tab" role="tabpanel">
            @await Html.PartialAsync("_Generate/ServerTab.cshtml", pageModel)
        </div>
    </div>
</div>

@section Scripts {
    <script src="js/lib/exif-reader.min.js"></script>
    <script src="js/genpage/helpers/browsers.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/server/logs.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/server/backends.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/presets.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/wildcards.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/loras.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/models.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/params.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/prompttools.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/utiltab.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/server/servertab.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/usertab.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/helpers/image_editor.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/helpers/generatehandler.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/simpletab.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/layout.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/helpers/metadatahelpers.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/generatecontrols.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/currentimagehandler.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/imagehistory.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/gentab/welcomemessages.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/main.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/helpers/settings_editor.js?vary=@Utilities.VaryID"></script>
    <script src="js/genpage/helpers/ui_improvements.js?vary=@Utilities.VaryID"></script>
    @WebServer.PageFooterExtra
    <script src="js/genpage/helpers/finalscript.js?vary=@Utilities.VaryID"></script>
}
